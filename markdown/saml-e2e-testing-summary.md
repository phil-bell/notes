# `SAML E2E Testing Summary`

## `Methods attempted`

### `mock-idp`
Library for mocking out SAML provider.

Initially it flat out didn't work out the box because the flask app it ran on didn't generate a secret, so I [forked the library](https://github.com/CrowdJustice/mock-idp/pull/1/files) to fix that.

It then wasn't passing back the RelayState so I added that too.

This allowed me to get it working to the point where cypress could login using the SAML login screen but unfortunutly the SAML response it would give to `django-social-auth` was not valid.

So I then attempted ammending the template it used to generate the response in the aim to fixing while also removing requirments for the response that social-auth required with the `SOCIAL_AUTH_SAML_SECURITY_CONFIG` ([docs](https://python-social-auth.readthedocs.io/en/latest/backends/saml.html#advanced-settings)). This got me to the point of the repsonse structure being valid but it still erroring because of an invalid signiture.

It was at this point I decided looking at other avenues may be more fruitful, as generating valid signitures may not be straight forward


### `django-social-auth mocking`

I lightly investigated if it would be possible to mock out some of the django-social-auth library without loosing the value of the test. I hypothesized mocking `socual_auth.views.auth` may be possible but as it was all behind the third party library and its django url routing I decided it may be more effort than its worth. It would also devalue the test.

### `okta (dev server)`

Closests to a working solution I got. This solution envovled setting up a [dev server with Okta](https://developer.okta.com/signup/).

Then adding a test Application to it that has the user created for the server.

This Application could then be added to our `CompanySAMLSettings` so a SAML user using the test account added to the Applications email could be signed up to our site using SAML.

The road block with this came with Cypress not allowing the origin to be changed mid test. This being a problem because when the user signs up they are redirected from our origin to oktas origin. settings `chromeWebSecurity` to `false` in `cypress.json` seemed to have no affect (possibly becuase the redirect happens in the front end).

I then tried grabbing the redirect url in the backend so I could send it to a seperate test (cypress allows origin switching between tests) but this is when I realised it doesnt return a 302, but a webpage that has a JS redirect.

So failing grabbing the URL generated by the JS and sending that to a different test I think we're pretty blocked when it comes to testing with cypress.

## `Posible next steps`

## `okta with another test framework`

Using the okta test server was definitly the closest I came to getting a working sollution. If we do come back to this I'd recomment continuing that direction but with another test framework that allows origin changing (Selenium possibly could do this).

The okta server that has the `Legl Test` test application is `dev-07866695.okta.com` and using `phil-bell` (my Github account) to sign in (with Github SSO ironically)

## `fully mocking django-social-auth`

A possible other solution while less valuable as it would be less real world would be to figure out a way to fully mock out `django-social-auth`. Could do this by having a url that overrides the `social:begin` url with something we build that signs in the user. 